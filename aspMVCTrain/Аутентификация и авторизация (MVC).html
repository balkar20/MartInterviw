<html>
<head>
  <title>Evernote Export</title>
  <basefont face="Arial" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/307934 (ru-RU, DDL); Windows/6.1.1 (Win64);"/>
  <style>
    body, td {
      font-family: Arial;
      font-size: 11pt;
    }
  </style>
</head>
<body>
<a name="538"/>

<div>
<span><div><div><div style="text-align: center;"><span style="font-size: 16pt;">Аутентификация и авторизация (<span style="font-size: 16pt;">MVC)</span></span></div><hr/><div><br/></div><div style="text-align: left;"><span style="font-weight: bold;">Аутентификация</span> - процесс идентификации пользователя (- Кто посетил сайт? - Пользователь dkhaikou)</div><div style="text-align: left;"><br/></div><div style="text-align: left;"><span style="font-weight: bold;">Авторизация</span> - процесс определения прав на доступ к ресурсам (- Набор ресурсов, которыми может манипулировать dkhaikou)</div><div style="text-align: center;"><br/></div><div style="text-align: center;"><br/></div><div style="text-align: center;"><span style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">Windows Authentication</span></span></div></div><div style="text-align: center;"><br/></div><div style="text-align: left;">Проверку подлинности Windows имеет смысл реализовывать при создании внутреннего веб-сайта компании (Intranet Application (2013) или тип аутентификации &quot;Проверка подлинности Windows&quot; (&gt;2015)). По умолчанию в проекте MVC включена Forms Authentication. </div><div style="text-align: left;">Для включения Windows Authentication нужно прописать в Web.config: <span style="line-height: 1.45;">&lt;authentication</span> <span style="font-weight: bold; line-height: 1.45;">mode=&quot;Windows&quot;</span><span style="line-height: 1.45;">&gt; &lt;/authentication&gt;</span></div><div style="text-align: left;"><br/></div><div style="text-align: left;">Если приложение развернуто на локальном IIS, необходимо включить Windows Authentication (Authentication &gt; Windows Authentication &gt; enabled)</div><div style="text-align: left;"><br/></div><div style="text-align: left;">Далее используя фильтры авторизации можно применить их к методам действия или контроллеру:</div><div style="text-align: left;"><ul><li>чтобы указать <span style="font-style: italic;">пользователей Windows</span>, который разрешен доступ к ресурсу;</li><li>чтобы указать <span style="font-style: italic;">группы Windows</span>, которым разрешен доступ к ресурсу<br/><br/></li></ul><div>[Домен\Логин]</div></div><div style="text-align: left;"></div><div>[Authorize (Users=@&quot;Dmitry-Lenovo\Дмитрий&quot;)]</div><div>[Authorize (Users=@&quot;ARTGROUP\dkhaikou&quot;)] </div><div style="text-align: left;"><br/></div><div style="text-align: left;"><div>[Authorize(Roles=&quot;Administrators&quot;)]</div></div><div style="text-align: left;"><div>[Authorize(Roles=&quot;Users&quot;)]</div></div><div style="text-align: left;"><div>[Authorize(Roles=&quot;MyGroup&quot;)]</div></div><div style="text-align: left;"><br/></div><div style="text-align: left;">В Windows существуют <a href="https://www.intuit.ru/studies/courses/1043/274/lecture/6939%3Fpage%3D1">стандартные группы</a> (Administrators, Users, Guests и др.), однако можно создавать и <a href="https://youtu.be/XMlDWrs1WOY">собственные группы</a> и включать в них пользователей. Каждый пользователель может состоять в нескольких группах.</div><div style="text-align: left;"><br/></div><div style="text-align: left;"><div><span style="line-height: 1.45;">HttpContext.User.IsInRole(&quot;Administrator&quot;)</span></div></div><div style="text-align: left;"><div>HttpContext.User.IsInRole(&quot;HelpLibraryUpdaters&quot;)</div></div><div style="text-align: left;"><br/></div><div style="text-align: left;"><br/></div><div style="text-align: left;">HTTP Error 401.0 - Unauthorized </div><div><br/></div><div><br/></div><div><a href="https://docs.microsoft.com/en-us/aspnet/mvc/overview/older-versions-1/security/authenticating-users-with-windows-authentication-cs">Authenticating Users with Windows Authentication (C#) Docs.microsoft</a></div><div><br/></div><div><br/></div><div style="text-align: center;"><font style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">Forms Authetication</span></font></div><div style="text-align: left;"><div><br/></div></div><div style="text-align: left;"><div><span style="font-size: 11pt;">Forms Authentication использует cookie-набор, в котором хранит аутентификационный тикет, содержащий базовую информацию о пользователе. Cookie-наборы шифруются ключами, которые генерирует веб-сервер. </span></div></div><div style="text-align: left;"><div><br/></div></div><div style="text-align: left;"><span style="font-size: 11pt;">(+):</span></div><div style="text-align: left;"><ul><li>Полный контроль над кодом аутентификации</li><li>Совместимость в любым браузером</li><li>Использование любого хранилища для хранения данных о пользователях (от Web.config до БД)</li></ul></div><div style="text-align: left;"><div><br/></div></div><div style="text-align: left;"><div><br/></div></div><div style="text-align: left;"><div><br/></div></div><div style="text-align: left;"><span style="font-size: 11pt;">При создании проекта выбираем No Authentication (Individual User Accounts использует аутентификацию Identity)</span></div><div style="text-align: left;"><div><br/></div></div><div style="text-align: left;">Для влючения Forms Authentication в Web.config установить:</div><div style="text-align: left;">&lt;authentication <span style="font-weight: bold;">mode=&quot;Forms&quot;</span>&gt;</div><div style="text-align: left;">    &lt;forms</div><div style="text-align: left;"><div>        <span style="font-weight: bold;">name</span>=&quot;auth&quot;                                 // Название <span style="font-size: 11pt;">cookie</span>-набора</div></div><div style="text-align: left;"><div><span style="font-weight: bold;">        timeout</span>=&quot;20&quot;                                // Кол-во минут, сколько будут действовать куки</div></div><div style="text-align: left;"><div>        <span style="font-weight: bold;">loginUrl</span>=&quot;~/Account/Login&quot;&gt;       // Адрес, на который будет перенаправлен пользователь, в случае отсуствия доступа к ресурсу.</div></div><div style="text-align: left;">        </div><div style="text-align: left;">     &lt;credentials <span style="font-weight: bold;">passwordFormat</span>=&quot;Clear&quot;&gt;             // Хеширование паролей (Clear - нет, MD5, SHA1)</div><blockquote style="margin: 0px 0px 0px 40px; border: none; padding: 0px;"><div style="text-align: left;">&lt;user name=&quot;Admin&quot; password=&quot;12345&quot; /&gt; </div><div style="text-align: left;">&lt;user name=&quot;Alex&quot; password=&quot;alexftw&quot;/&gt; </div><div style="text-align: left;">&lt;user name=&quot;Elena&quot; password=&quot;12fgap8&quot;/&gt;</div></blockquote><div><span style="line-height: 1.45;">     &lt;/</span><span style="line-height: 1.45;">credentials</span><span style="line-height: 1.45;">&gt;</span></div><div style="text-align: left;">    &lt;/forms&gt;</div><div style="text-align: left;"><div>&lt;/authentication&gt;</div></div><div style="text-align: left;"><br/></div><div style="text-align: left;">&lt;authorization&gt; </div><div style="text-align: left;">        &lt;deny users=&quot;?&quot;/&gt;                         // Запрещает доступ к ресурсам всем анонимным пользователям (?)</div><div style="text-align: left;">&lt;/authorization&gt;</div><div style="text-align: left;"><div><br/></div></div><div style="text-align: left;"><br/></div><div style="text-align: left;"><div style="text-align: center;">using System.Web.Security</div><table style="border-collapse: collapse; min-width: 100%;"><colgroup><col style="width: 472px;"></col><col style="width: 593px;"></col></colgroup><tbody><tr><td style="border: 1px solid rgb(204, 204, 204); width: 472px; padding: 8px;"><div>FormsAuthentication.Authenticate(Name, Password)</div></td><td style="border: 1px solid rgb(204, 204, 204); width: 593px; padding: 8px;"><div>Метод аутентификации (LogIn). Сверяет переданные логин и пароль с хранящимися в Web.config</div></td></tr><tr><td style="border: 1px solid rgb(204, 204, 204); width: 472px; padding: 8px;"><div>FormsAuthentication.SignOut()</div></td><td style="border: 1px solid rgb(204, 204, 204); width: 593px; padding: 8px;"><div>Выход пользователя (удаляется cookie-набор)</div></td></tr><tr><td style="border: 1px solid rgb(204, 204, 204); width: 472px; padding: 8px;"><div>FormsAuthentication.SetAuthCookie(userName, true)</div></td><td style="border: 1px solid rgb(204, 204, 204); width: 593px; padding: 8px;"><div>Создает аутентификационный тикет, неявно зашифровывает его и устанавливает в cookie ответа. true - длительное хранение cookie (сохранение между сеансами браузера).</div><div>User.Identity.IsAuthenticated будет true, только в том случае, когда с клиента прилетает тикет.</div></td></tr><tr><td style="border: 1px solid rgb(204, 204, 204); width: 472px; padding: 8px;"><div>var userTicket = new FormsAuthenticationTicket(&quot;user&quot;, true, 20)</div><div>string encryptTicket = FormsAuthentication.Encrypt(userTicket)</div><div>userTicket = FormsAuthentication.Decrypt(encryptTicket)</div></td><td style="border: 1px solid rgb(204, 204, 204); width: 593px; padding: 8px;"><div>Создание тикета для пользователя &quot;user&quot;</div><div>Шифрование тикета, получается готовый к отправке cookie-набор</div><div>Дешифровка тикета</div></td></tr></tbody></table><div><br/></div><div style="text-align: center;">Разграничение доступа по ролям</div><div><br/></div><div>Для этого используются провайдеры ролей. Установим из NuGet пакет ASP.NET Universal Providers. В Web-config добавится ряд универсальных провайдеров: профилей (информация о пользователях - фамилия, возраст и прочее, управление профилями), членства  (Membership API - управление регистрационными данными пользователей), ролей (Roles API - разграничение доступа по ролям, управление ролями). Эти провайдеры предоставляют готовую реализацию по работе с пользователями, однако ее можно расширить и переопределить. Создадим собственный класс провайдера ролей, наследуем от абстрактного класса RoleProvider, переопределяем методы GetRolesForUser() и IsUserInRole(), в которых используем взаимодействие с базой, где хранятся данные о ролях и в Web.config указываем в качестве провайдера этот класс. После этого можно использовать атрибут с параметром Roles: [Authorize(Roles=&quot;Admin, HR&quot;)]</div><div><br/></div><div>Класс Roles использует какой-либо из провайдеров RoleProvider, например, SqlRoleProvider.</div><div><br/></div><div><ul><li><span style="line-height: 1.45;">Roles.CreateRole(</span><span style="line-height: 1.45;">&quot;rolename&quot;</span><span style="line-height: 1.45;">);</span></li><li><span style="line-height: 1.45;">Roles.DeleteRole(</span><span style="line-height: 1.45;">&quot;rolename&quot;</span><span style="line-height: 1.45;">);</span></li><li><span style="line-height: 1.45;">Roles.GetAllRoles();</span></li><li><span style="line-height: 1.45;">Roles.GetRolesForUser(</span><span style="line-height: 1.45;">&quot;username&quot;</span><span style="line-height: 1.45;">);</span></li><li><span style="line-height: 1.45;">Roles.IsUserInRole(</span><span style="line-height: 1.45;">&quot;username&quot;</span><span style="line-height: 1.45;">,</span> <span style="line-height: 1.45;">&quot;rolename&quot;</span><span style="line-height: 1.45;">);</span></li></ul><div><br/></div></div><div style="text-align: center;">Forms Authentication &gt; Membership API &gt; SimpleMembershipProvider (MVC4)</div><div><br/></div><div><a href="https://ru.wikipedia.org/wiki/Membership_API">Membership API</a> - платформа, основанная на аутентификации форм, которая предоставляет готовую функциональность для управления пользователями:</div><div><ul><li><span style="line-height: 1.45;">Создание пользователя -</span> <span style="line-height: 1.45;">Membership.CreateUser(</span><span style="line-height: 1.45;">&quot;username&quot;</span><span style="line-height: 1.45;">,</span> <span style="line-height: 1.45;">&quot;password&quot;</span><span style="line-height: 1.45;">)</span></li><li><span style="line-height: 1.45;">Удаление пользователя - Membership.DeleteUser(&quot;username&quot;)</span></li><li><span style="line-height: 1.45;">Получение пользователей - Membership.GetAllUsers()</span></li><li><span style="line-height: 1.45;">Изменение пароля - Membership.GetUser().ChangePassword(&quot;oldPassword&quot;, &quot;newPassword&quot;)</span></li><li><span style="line-height: 1.45;">Сброс пароля</span></li><li><span style="line-height: 1.45;">Автоматическая генерация пароля и др</span><br/><br/></li></ul><div><span style="line-height: 1.45;">Membership API не зависит от используемого им хранилища данных (SQL Server, AD и др), для этой независимости используются разные поставщики данных (SqlMembershipProvider : MembershipProvider или ActiveDirectoryMembershipProvider : MembershipProvider). Можно создать собственный поставщик членства, унаследовав его от асбтрактного класса MembershipProvider. Конфигурировать провайдеры необходимо в Web.config (например, SqlMembershipProvider или пользовательский провайдер), после этого класс Membership для взаимодействием с хранилищем будет использовать указанный в Web.config провайдер.</span></div></div><div><br/></div><div><br/></div><div style="text-align: center;"><span style="font-size: 12pt; font-weight: bold;">SimpleMembershipProvide</span><span style="font-size: 12pt; font-weight: bold;">r</span> <span style="font-size: 12pt; font-weight: bold;">и SimpleRoleProvider</span></div><div style="text-align: left;"><br/></div><div style="text-align: left;">Пришли на смену универсальных провайдеров членства и ролей.</div><div style="text-align: left;"><br/></div><div style="text-align: left;">- SimpleMemberShipProvider пришел на смену MemberShipProvider</div><div style="text-align: left;">- Призван упростить процесс аутентификации и авторизации</div><div style="text-align: left;">- Добавлена поддержка OAuth - протокол авторизации, позволяющий зарегистрироваться на сайте с использованием стороннего веб-сервиса, например, google или facebook, без необходимости сообщать сайту пароль от этих сервисов. </div><div style="text-align: left;"></div><div style="text-align: left;"><div><br/></div><table style="border-collapse: collapse; min-width: 100%;"><colgroup><col style="width: 296px;"></col><col style="width: 472px;"></col></colgroup><tbody><tr><td style="border: 1px solid rgb(204, 204, 204); width: 296px; padding: 8px;"><div>Войти</div></td><td style="border: 1px solid rgb(204, 204, 204); width: 472px; padding: 8px;"><div><span style="line-height: 1.45;">WebSecurity.Login(</span><span style="line-height: 1.45;">&quot;username&quot;</span><span style="line-height: 1.45;">,</span> <span style="line-height: 1.45;">&quot;password&quot;</span><span style="line-height: 1.45;">, persistCookie:</span> <span style="line-height: 1.45;">true</span><span style="line-height: 1.45;">);</span></div></td></tr><tr><td style="border: 1px solid rgb(204, 204, 204); width: 296px; padding: 8px;"><div>Выйти</div></td><td style="border: 1px solid rgb(204, 204, 204); width: 472px; padding: 8px;"><div>WebSecurity.Logout();</div></td></tr><tr><td style="border: 1px solid rgb(204, 204, 204); width: 296px; padding: 8px;"><div>Получить провайдер ролей</div></td><td style="border: 1px solid rgb(204, 204, 204); width: 472px; padding: 8px;"><div>SimpleRoleProvider roles = (SimpleRoleProvider)Roles.Provider;</div></td></tr><tr><td style="border: 1px solid rgb(204, 204, 204); width: 296px; padding: 8px;"><div>Создать роль</div></td><td style="border: 1px solid rgb(204, 204, 204); width: 472px; padding: 8px;"><div>roles.CreateRole(&quot;rolename&quot;);</div></td></tr><tr><td style="border: 1px solid rgb(204, 204, 204); width: 296px; padding: 8px;"><div>Принадлежит ли пользователь роли</div></td><td style="border: 1px solid rgb(204, 204, 204); width: 472px; padding: 8px;"><div>roles.IsUserInRole(&quot;username&quot;, &quot;rolename&quot;);</div></td></tr></tbody></table><div><br/></div><div style="text-align: center;">Таблицы  в БД</div><div style="text-align: left;"><ul><li>Таблица членства (регистрационные данные: логины, пароли)</li><li>Таблица профилей</li><li>Таблица ролей</li><li>Таблица связи пользователей с ролями</li></ul></div><div><br/></div><div><br/></div></div><div style="text-align: left;"><div><a href="https://habr.com/post/192238/" style="line-height: 1.45;">Руководство SimpleMembership в ASP.NET MVC 4 (habr)</a></div></div><div style="text-align: left;"><div><a href="https://metanit.com/sharp/mvc/11.4.php">Авторизация в MVC 4 и SimpleMembershipProvider (metanit)</a></div></div><div style="text-align: left;">ITVDN - Урок 7</div><div><br/></div><div><br/></div><div style="text-align: center;"><font style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">ASP.NET Identity</span></font></div><div style="text-align: center;"><div><br/></div></div><div style="text-align: left;">Identity (MVC5) - API, для  управления аутентификацией (проверкой подлинности) и авторизацией, призванный заменить Membership API.</div><div style="text-align: center;"><div><br/></div></div><div style="text-align: left;">(+):</div><div style="text-align: left;"><ul><li>Возможность внедрения в любой проект (MVC, Web Forms, Web API)</li><li>Работа на OWIN - Open Web Interface for .NET - спецификация описывающее взаимодействие между компонентами веб-приложения и позволяет подключать только нужные компоненты</li></ul></div><div style="text-align: center;"><div><br/></div></div><div style="text-align: left;"><div><br/></div></div><div style="text-align: left;"><span style="font-size: 11pt;">Таблицы в БД:</span></div><div style="text-align: left;"><span style="font-size: 11pt;">- Users (регистрационная информация)</span></div><div style="text-align: left;"><span style="font-size: 11pt;">- UserClaims (дополнительная информация о пользователях: возраст, адрес и тд)</span></div><div style="text-align: left;"><span style="font-size: 11pt;">- Roles</span></div><div style="text-align: left;"><span style="font-size: 11pt;">- UserRoles</span></div><div style="text-align: left;"><div><br/></div></div><div style="text-align: center;"><div><br/></div></div><div style="text-align: center;"><div><br/></div></div><div style="text-align: center;"><div><br/></div></div><div style="text-align: center;"><div><br/></div></div><div style="text-align: center;"><div><br/></div></div><div style="text-align: center;"><div><br/></div></div><div style="text-align: center;"><div><br/></div></div><div style="text-align: center;"><div><br/></div></div><div style="text-align: center;"><div><br/></div></div><div style="text-align: center;"><div><br/></div></div><div style="text-align: center;"><div><br/></div></div><div style="text-align: center;"><div><br/></div></div><div style="text-align: center;"><div><br/></div></div><div style="text-align: center;"><div><br/></div></div><div style="text-align: center;"><div><br/></div></div><div style="text-align: center;"><div><br/></div></div><div style="text-align: center;"><div><br/></div></div><div><br/></div><div><br/></div></div><div style="text-align: left;"><div><a href="https://youtu.be/iJ25Jr98YaY">Модуль 58. Авторизация и аутентификация форм в ASP.NET MVC 5</a></div></div><div style="text-align: left;"><div><a href="https://youtu.be/-1sjWBywnIg">Модуль 59. Добавление провайдера ролей в ASP.NET MVC 5</a></div></div><div style="text-align: left;"><br/></div><div style="text-align: left;"><div><a href="https://youtu.be/AoRWKBbc6QI">Forms authentication using user names list in web.config Part 90</a></div><div><a href="https://youtu.be/nmgLMqB_1uA">Part 1 - How to implement custom Forms Authentication in ASP.NET MVC application</a></div></div><div style="text-align: left;"><div><a href="https://youtu.be/PCtfCAjAA3A">Part 2 - How to implement custom Forms Authentication in ASP.NET MVC4 application</a></div></div><div style="text-align: left;"><div><a href="https://youtu.be/viVfYmEuKIk">Part 3 - How to implement custom Forms Authentication in ASP.NET MVC4 application</a></div></div><div style="text-align: left;"><br/></div><div style="text-align: left;"><div><a href="https://habr.com/company/dataart/blog/311376/">Аутентификация и авторизация в микросервисных приложениях (habr)</a></div></div><div style="text-align: left;"><div><a href="https://habr.com/company/dataart/blog/262817/">Обзор способов и протоколов аутентификации в веб-приложениях (habr)</a></div></div><div style="text-align: left;"><br/></div><div style="text-align: left;"><br/></div><div style="text-align: left;"><br/></div><div style="text-align: left;"><br/></div><div style="text-align: left;"><br/></div><div style="text-align: left;"><br/></div><div style="text-align: left;"><br/></div><div style="text-align: left;"><br/></div><div style="text-align: left;"><br/></div><div style="text-align: left;"><br/></div><div style="text-align: left;"><br/></div><div style="text-align: left;"><br/></div><div style="text-align: left;"><br/></div><div style="text-align: left;"><br/></div><div style="text-align: left;"><br/></div><div style="text-align: left;"><div><br/></div></div><div style="text-align: left;"><div><br/></div></div><div style="text-align: left;"><div><br/></div></div><div style="text-align: left;"><div><br/></div></div><div style="text-align: center;"><br/></div><div style="text-align: center;"><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><ul><li><span style="line-height: 1.45;">HTTP Authentication:</span></li><ul><li>Basic </li><li>Digest</li></ul><li>Forms Authentication:</li><ul><li>Stateless</li><li>Stateful</li></ul><li>Token Authentication</li></ul><div><br/></div></div><div><br/></div><div>      MVC</div><div><ul><li>Windows Authentication</li><li>Forms Authentication</li><li>Membership API</li><li>Simple Membership API (+OAuth)</li><li>Identity (+OWIN, Katana)</li></ul></div><div><br/></div><div><br/></div><div><ul><li><span style="line-height: 1.45;">HttpContext</span></li><ul><li><span style="line-height: 1.45;"><span style="line-height: 1.45;">IPrincipal </span>User(сведения о пользователе текущего HTTP-запроса)</span></li><ul><li>IIdentity Identity(удостоверение участника)</li><ul><li>Name</li><li>AuthenticationType</li><li>IsAuthenticated</li></ul><li>bool IsInRole(string role)</li></ul></ul></ul></div><div><br/></div><div>[Authorize] [AllowAnonimous]</div><div><br/></div><div><br/></div><div><br/></div><div>WWW-Authenticate: Basic - этот заголовок посылается с 401, в результате чего браузер автоматически выводит стандартное окно аутентификации</div><div>Authorization: Basic YWRtaW46YWRtaW4= - клиент отправляет серверу в Base64 admin:admin</div><div><br/></div><div>Digest Authentication - использует MD5-шифрование логин:пароля, в результате чего по сети передается хэш.</div><div><br/></div><div>HTTP Code 401, 403</div><div><br/></div><div><br/></div><div>HttpContext.User, IPrincipal, IIdentity</div><div>[Authorize] [AllowAnonimous]</div><div><br/></div><div><br/></div><div><br/></div><div>mode=&quot;Forms&quot;, атрибуты</div><div style="text-align: left;">FormsAuthentication.SetAuthCookie()</div><div style="text-align: left;"><br/></div><div>Метод действия Login(loginModel, returnUrl) - если логин и пароль корректны, то редирект на returnUrl</div><div><br/></div></div><div><br/></div></span>
</div></body></html> 