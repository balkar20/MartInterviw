<html>
<head>
  <title>Evernote Export</title>
  <basefont face="Arial" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/308555 (ru-RU, DDL); Windows/6.1.1 (Win64);"/>
  <style>
    body, td {
      font-family: Arial;
      font-size: 11pt;
    }
  </style>
</head>
<body>
<a name="630"/>

<div>
<span><div><div style="text-align: center;"><font style="font-size: 14pt;">IIS конфигурирование. Фильтры, Модули, Домены</font></div><hr/><div style="text-align: left;"><br/></div><ul><li><div style="text-align: left;">Архитектура</div></li><li><div style="text-align: left;">Публикация на сервере</div></li><li><div style="text-align: left;">Основные настройки</div></li><li><div style="text-align: left;">Домены приложений</div></li><li><div style="text-align: left;">Модули</div></li><li><div style="text-align: left;">Фильтрация запросов</div></li><li><div style="text-align: left;">Фильтры ISAPI, CGI</div></li></ul><div style="text-align: left;"><br/></div><hr/><div style="text-align: left;"><br/></div><div style="text-align: center;"><font style="font-size: 12pt;"><b>Архитектура IIS</b></font></div><div style="text-align: left;"><br/></div><div style="text-align: left;">Конвейер обработки запроса:</div><ol><li><div style="text-align: left;">Клиент отправляет запрос</div></li><li><div style="text-align: left;">На сервере запрос перехватывает драйвер уровня ядра http.sys</div></li><li><div style="text-align: left;">http.sys → WAS (чтобы получить информацию о конфигурирации из хранилища)</div></li><li><div style="text-align: left;">WAS → applicationHost.config (конфигурация пула приложений, сайта)</div></li><li><div style="text-align: left;">WAS → W3SVC (передает информацию о конфигурации соответсвующему адаптеру слушателя; для слушателя http.sys адаптером является служба W3SVC)</div></li><li><div style="text-align: left;">W3SVC → http.sys</div></li><li><div style="text-align: left;">WAS → w3wp.exe (создает процесс, в котором выполняется веб-приложение, если этот процесс не был создан ранее)</div></li><li><div style="text-align: left;">w3wp.exe → http.sys → ответ клиенту</div></li><li><div style="text-align: left;">последующие запросы → http.sys →  <span style="color: rgb(0, 0, 0); font-family: Arial; font-size: medium; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;">w3wp.exe → </span>http.sys</div></li></ol><div style="text-align: left;"><br/></div><div style="text-align: left;"><b>http.sys</b> — это системный встроенный в ядро драйвер HTTP.sys, который является протокольным слушателем (protocol listener) запросов, работающих по протоколам HTTP, HTTPS. Запросы, которые в данный момент не может обработать помещает в отведенную для каждого пула очередь. По умолчанию число запросов, которые единовременно могут обрабатываться на 1 ядре ПК = 5000, для их обработки используется пул потоков. Остальные запросы будут помещаться в очередь. Если и очередь будет заполнена полностью (1000), то сервер вернет ошибку 503 Service Unavailable. Выполняет кэширование ответов, в результате чего запросы поступающие по одному и тому же URL не будут передаваться на уровень приложения, а будут браться из кэша. (Все запросы к статическому содержимому исполняются самим http.sys. (??))</div><div style="text-align: left;"><br/></div><div style="text-align: left;"><b><a href="https://en.wikipedia.org/wiki/Windows_Activation_Services">WAS</a></b> (Windows Process Activation Service) — служба активации процессов Windows. Управляет рабочими процессами: выполняет сопоставление между пулами приложений и рабочими процессами (w3wp.exe), если для пула процесс не запущен, то запускает его. Также считывает конфигурационную информацию о веб-приложениях и пулах из applicationHost.config и передает ее соответствующему адаптеру слушателя, например, W3SVC. Служба работает внутри процесса svchost.exe<br/></div><div style="text-align: left;"><br/></div><div style="text-align: left;"><b>W3SVC</b> (World Wide Web Publishing Service) — служба веб-публикации, занимается конфигурированием http.sys и мониторингов показателей производительности. Работает внутри процесса svchost.exe.</div><div style="text-align: left;"><br/></div><div style="text-align: left;"><b>Application Pools</b> — пулы приложений, служат для изолированного выполенения веб-приложений. Веб-приложения, запущенные на разных пулах, будут выполняться в отдельных процессах w3wp.exe. Пул приложения можно сконфигурировать нужным образом. Тем не менее, разные веб-приложения могут использовать один пул (с одним процессом w3wp.exe), в таком случае изоляция будет осуществляться посредством того, что веб-приложения будут исполняться в собственных доменах приложений (Application Domain). Если пул приложения сконфигурирован таким образом, что позволяет создавать более одного рабочего процесса w3wp.exe, то он называется веб-садом (Web Garden). Для каждого пула существует отдельная очередь.</div><div style="text-align: left;"><br/></div><div style="text-align: left;"><b>Classic Mode</b> — конвейер запросов IIS отделен от конвейера запросов ASP.NET. Это означает, что запрос к ресурсу ASP.NET вначале пройдет через нативные модули в IIS, после чего напрваляется в Aspnet_isapi.dll и проходит через все управляемые модули. А так как в управляемых модулях, есть аналоги нативных, то по сути некоторые модули будут вызваны дважды. Когда запрос будет адресован статическому ресурсу, то он будет пропущен лишь через конвейер запросов IIS (то есть IIS самостоятельно будет обрабатывать запросы к статическим ресурсам без привлечения ASP.NET ISAPI). Это в свою очередь означает, что некоторые функции например, авторизацию, необходимо будет реализовать еще и в IIS, для разграничения доступа к статическим ресурсам. Также стоит отметить, что существуют управляемые модули, для которых не существует аналогов среди нативных, например, FormsAuthentication. Этот режим был стандартным в IIS6.</div><div style="text-align: left;"><br/></div><div style="text-align: left;"><b>Integrated Mode</b> — запросы к статическим и ASP.NET ресурсам проходят через один и тот же унифицированный конвейер. Устраняет вызов модулей, который ранее дублировались в IIS и ASP.NET конвейерах (например, модули проверки подлинности). Теперь вместо двух конвейеров был введен один интегрированный конвейер обработки запроса, в котором нативные и управляемые модули вызываются при наступлении соответствующего события.</div><div style="text-align: left;"><br/></div><div style="text-align: left;">Конфигурирование пула:</div><ul><li><div style="text-align: left;">Managed pipeline mode: classic mode, integrated mode</div></li><li><div style="text-align: left;">Queue length: 1000 </div></li><li><div style="text-align: left;"><a href="https://windowsnotes.ru/iis/application-pool-identities-v-iis/">Identity</a>: ApplicationPoolIdentity | LocalService | NetworkService | LocalSystem — учетная запись от имени которой будет запускать пул</div></li><li><div style="text-align: left;">Idle Time-out: 20 — количество минут по истечению которых рабочий процесс должен быть выгружен, если не поступит ни одного запроса</div></li><li><div style="text-align: left;">Maximum worker processes: 1 — максимальное количество рабочих процессов (w3wp.exe), которые могут быть запущены под этим пулом. Если больше 1, то пул называется Web Garden.</div></li><li><div style="text-align: left;">Application pool recycling: 1740 — перезапуск рабочего процесса (w3wp.exe). Можно использовать разные условия: интервал, точное время или объем памяти, отведенной под процесс, по достижении которого будет выполнен перезапуск. Средство от утечек памяти.</div></li></ul><div style="text-align: left;"><br/></div><div style="text-align: left;">Конфигурирование Веб-сайта:</div><ul><li><div style="text-align: left;">Bindings — позволяет задать привязку ip к host name</div></li></ul><div style="text-align: left;"><br/></div><div style="text-align: left;">На одном веб-сайте можно создавать множество приложений. Конфигурирование приложений:</div><ul><li><div style="text-align: left;">Basic Settings: application pool, physical path, alias</div></li></ul><div style="text-align: left;"><br/></div><div style="text-align: left;"><b>Модули</b> — обспечивают дополнительную сквозную функциональность для веб-приложения при обработке запросов. То есть запрос, попав в w3wp.exe проходит через ряд модулей, которые добавляют некоторую функциональность в процесс его обрбаботки.</div><div style="text-align: left;">Например, нативный модуль HttpCacheModule реализует логику кэшировния в драйвере http.sys, и его удаление приведет к тому, что ответы перестанут кэшироваться на уровне ядра, что вероятно негативно скажется на производительности. Нативный HttpLogginhModule обеспечивается стандартное логирование запросов в IIS. Нативный RequestFilteringModule реализует логику по фильтрации запросов и в случае удаления правила, определенные в RequestFiltering перестанут работать. Нативный WindowsAuthenticationModule реализует Windows аутентификацию и тд. Наличие концепции модулей, позволяет не перегружать IIS жестко встроенной функциональностью, а гибко подключать ее тогда, когда это необходимо. </div><div style="text-align: left;"><br/></div><div style="text-align: left;">Представляют собой библиотеки dll и бывают нативными (системными сборками, поставляемыми с IIS) и управляемыми (managed), т.е. сборками .NET Framework. Каждый такой модуль ассоциируется с определенным событием / событиями обработки запроса и вызывается при его наступлении. </div><div style="text-align: left;"><br/></div><div style="text-align: left;">Чтобы добавить нативный модуль, необходимо вначале зарегистрировать его на уровне всего IIS, а после включить его в нужном веб-приложении. Чтобы добавить управляемый модуль, достаточно включить его на уровне веб-приложения (не регистрируя глобально). Если веб-приложение запущено на пуле в классическом режиме??, тогда управляемые модули можно добавлять в web.config вашего приложения (&lt;system.webServer&gt; &lt;modules&gt; &lt;add ... /&gt; &lt;/modules&gt; &lt;/system/webServer&gt;). Некоторые из них уже зарегистрированы в корневом web.config .NET Framework.</div><div style="text-align: left;"><br/></div><div style="text-align: left;"><b>Application Domain</b> (Домены приложений) — логический контейнер, позволяющий запустить несколько приложений в одном процессе, обеспечивая относительную изоляцию их друг от друга (нельзя получить доступ к глобальной переменной одного домена из другого домена). Процесс может содержать множество доменов приложений, а домен множество потоков. Если процесс создает ОС, то домен создает среда CLR.</div><div style="text-align: left;"><br/></div><div style="text-align: left;">Для веб-сайта или приложения можно указать Request Filtering, которая представляет собой набор правил, определяющих должен ли быть предоставлен доступ к тем либо иным ресурсам. Запрет на доступ к ресурсам может определяться на основании расширения файла, сегмента, урла, HTTP глагола, наличия указанного заголовка. </div><div style="text-align: left;"><br/></div><div style="text-align: left;"><br/></div><div style="text-align: left;"><br/></div><div style="text-align: left;"><br/></div><div style="text-align: left;"><br/></div><div style="text-align: left;"><br/></div><div style="text-align: left;"><br/></div><div style="text-align: left;"><br/></div><div style="text-align: left;"><br/></div><div style="text-align: left;"><br/></div><div style="text-align: left;"><br/></div><div style="text-align: left;"><br/></div><div style="text-align: left;"><br/></div><div style="text-align: left;"><br/></div><div style="text-align: left;"><br/></div><div style="text-align: left;"><br/></div><div style="text-align: left;"><br/></div><div style="text-align: left;"><br/></div><div style="text-align: left;"><br/></div><div style="text-align: left;"><br/></div><div style="text-align: left;"><br/></div><div style="text-align: left;"><br/></div><div style="text-align: left;"><br/></div><div style="text-align: left;"><a href="https://metanit.com/sharp/articles/mvc/10.php">Работа конвейера веб-сервера IIS (метанит)</a><br/></div><div style="text-align: left;"><a href="https://habr.com/post/189086/">Основы архитектуры IIS, или запросопровод для ASP.NET (habr)</a><br/></div><div style="text-align: left;"><a href="https://docs.microsoft.com/en-us/iis/get-started/introduction-to-iis/introduction-to-iis-architecture">Introduction to IIS Architectures (microsoft.com)</a><br/></div><div style="text-align: left;"><br/></div><div style="text-align: left;"><br/></div><div style="text-align: left;"><br/></div><div style="text-align: left;"><br/></div><div style="text-align: left;"><br/></div><div style="text-align: left;"><br/></div><div style="text-align: left;"><br/></div><div style="text-align: left;"><br/></div><div style="text-align: left;"><br/></div><div style="text-align: left;"><br/></div><div style="text-align: left;"><br/></div><div style="text-align: left;"><br/></div><div style="text-align: left;"><br/></div><div style="text-align: left;"><br/></div><div style="text-align: left;"><br/></div><div style="text-align: left;"><br/></div><div style="text-align: left;"><br/></div><div style="text-align: left;"><br/></div><div style="text-align: left;"><br/></div><div style="text-align: left;"><br/></div><div style="text-align: left;"><br/></div><div style="text-align: left;"><br/></div><div style="text-align: left;"><br/></div></div></span>
</div></body></html> 